<style>
  table#gapps_cal td.saturday{background-color:#F5FFFA}
  table#gapps_cal td.sunday{background-color:#FFF0F5}
  table#gapps_cal td.date{font-size:14px;text-align:center;vertical-align:center;}
  table#gapps_cal td.detail{vertical-align:top;}
  table#gapps_cal td.detail ul{list-style-position:inside;padding:2px 2px;font-size:14px;margin:0}
  table#gapps_cal td.detail ul li{padding:2px}
</style>
<%# TODO: 以下のロジックをcontrollerに %>
<% xml_doc = REXML::Document.new @calenders -%>
<% record_date = Date.today -%>
<div id="gadget_wrapper" class="ui-corner-all">
  <h2 class="ui-corner-top"><%= icon_tag("new") + "カレンダー " %><%= "(" + record_date.strftime('%Y年%m月%d日') + ")" %></h2>

<table id="gapps_cal" width="100%" cellspacing="0" border="1" border-color="#999999" style="padding:10px 10px;">
  <col width="20%" />
  <col />
  <tbody>
    <% for i in 0..6 -%>
      <tr>
        <td class="date <%= date2wday(record_date + i) %>">
          <%= (record_date + i).day %><%= "日" %>
        </td>
        <td class="detail">
          <ul>
            <%# TODO:helperメソッドとしてロジックはviewから排除する -%>
            <% xml_doc.elements.each("feed/entry") do |calender| -%>
              <%# TODO:繰り返し登録にも対応するように %>
              <% if calender.elements['gd:when'] -%>
                <% st = ParseDate::parsedate(calender.elements['gd:when'].attribute('startTime').to_s) -%>
                <% et = ParseDate::parsedate(calender.elements['gd:when'].attribute('endTime').to_s) -%>
                <% start_time = Time::local(*st[0..-3]).strftime("%H:%M") %>
                <% end_time = Time::local(*et[0..-3]).strftime("%H:%M") %>

                <% if (Time::local(*st[0..-3]).day == (record_date + i).day || (Time::local(*st[0..-3]).day <= (record_date + i).day && (record_date + i).day < Time::local(*et[0..-3]).day)) -%>
                  <li>
                    <%# TODO:linkのhrefが複数あることを考慮すること -%>
                    <%= link_to(h(truncate(calender.elements['title'].text, 20)), calender.elements['link'].attribute('href').to_s) -%>
                    <% if (start_time == "00:00" && end_time == "00:00") -%>
                      <%= "終日" %>
                    <% else -%>
                      <%= start_time %>-<%= end_time %>
                    <% end -%>
                  </li>
                <% end -%>
              <% end -%>
            <% end -%>
          </ul>
          <div align="right">
            <%= link_to(icon_tag("page_edit"), "http://www.google.com/calendar/hosted/#{gapps_domain}/event?action=TEMPLATE&text=&dates=#{Time.now.since(i.days).utc.strftime("%Y%m%dT%H%M%SZ")}/#{Time.now.since(i.days + 1.hours).utc.strftime("%Y%m%dT%H%M%SZ")}") %>
          </div>
        </td>
      </tr>

    <% end -%>
  </tbody>
</table>
</div>
<br/>
