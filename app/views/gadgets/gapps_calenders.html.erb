<style>
  table#gapps_cal{border:1px solid #999999}
  table#gapps_cal tr.saturday{background-color:#CCFFFF}
  table#gapps_cal tr.sunday{background-color:#FFCCCC}
  table#gapps_cal td.date{text-align:center;vertical-align:center;}
  table#gapps_cal td.detail{vertical-align:top}
  table#gapps_cal td.detail ul{list-style-position:inside;padding:2px 2px;font-size:14px;margin:0}
  table#gapps_cal td.detail ul li{padding:2px}
  table#gapps_cal td{border:1px solid #999999;}
</style>
<%# TODO: 以下のロジックをcontrollerに %>
<% xml_doc = REXML::Document.new @calenders -%>
<% record_date = Date.today -%>

<div align="center" style="font-weight:bold;font-size:16px;color:#444444;">
  <%= record_date.strftime('%Y年%m月%d日') %>
</div>

<table id="gapps_cal" class="ui-corner-all" width="100%">
  <col width="20%" />
  <col />
  <tbody>
    <% for i in 0..6 -%>
      <tr class="<%= date2wday(record_date + i) %>">
        <td class="date ui-corner-all">
          <%= (record_date + i).day %><%= "日" %>
        </td>
        <td class="detail <%= date2wday(record_date + i) %> ui-corner-all">
          <ul>
            <%# TODO:helperメソッドとしてロジックはviewから排除する -%>
            <% xml_doc.elements.each("feed/entry") do |calender| -%>
              <%# TODO:繰り返し登録にも対応するように %>
              <% if calender.elements['gd:when'] -%>
                <% st = ParseDate::parsedate(calender.elements['gd:when'].attribute('startTime').to_s) -%>
                <% et = ParseDate::parsedate(calender.elements['gd:when'].attribute('endTime').to_s) -%>
                <% start_time = Time::local(*st[0..-3]).strftime("%H:%M") %>
                <% end_time = Time::local(*et[0..-3]).strftime("%H:%M") %>

                <% if (Time::local(*st[0..-3]).day == (record_date + i).day || (Time::local(*st[0..-3]).day <= (record_date + i).day && (record_date + i).day < Time::local(*et[0..-3]).day)) -%>
                  <li>
                    <%# TODO:linkのhrefが複数あることを考慮すること -%>
                    <%= link_to(h(truncate(calender.elements['title'].text, 20)), calender.elements['link'].attribute('href').to_s) -%>
                    <% if (start_time == "00:00" && end_time == "00:00") -%>
                      <%= "終日" %>
                    <% else -%>
                      <%= start_time %>-<%= end_time %>
                    <% end -%>
                  </li>
                <% end -%>
              <% end -%>
            <% end -%>
          </ul>
          <div align="right">
            <%= link_to(icon_tag("page_edit"), "http://www.google.com/calendar/hosted/#{gapps_domain}/event?action=TEMPLATE&text=&dates=#{Time.now.since(i.days).utc.strftime("%Y%m%dT%H%M%SZ")}/#{Time.now.since(i.days + 1.hours).utc.strftime("%Y%m%dT%H%M%SZ")}") %>
          </div>
        </td>
      </tr>

    <% end -%>
  </tbody>
</table>
<br/>
